#!/bin/zsh

() {
	setopt LOCAL_OPTIONS LOCAL_TRAPS PIPE_FAIL;

	source ~/.config/zsh-ex/config;

	local SF=${(%):-%x};
	local SD=${SF:h};

	TRAPINT() { return $(( 128 + $1 )); }
	TRAPABRT() { return $(( 128 + $1 )); }

	help() {
		print -l "`cat $SF | \pcregrep -o1 '^##\t(.+)$'`";
		kill -ABRT $$;
	}

	error() {
		echo "\e[31;1m$@\e[m";
		help;
	}

	vmsg() {
		[[ $1 > $VERBOSITY ]] &&
			return;
		shift;	# Drop $1
		echo $*;
	}

	# Default Options
	_TAIL_N=(-n 50000);

	# Parse Options
	zparseopts -D -E -K v+=VERBOSITY h=HELP n:=_TAIL_N ||
		help;

	VERBOSITY=${#VERBOSITY}

	[[ "$HELP" != '' ]] &&
		help;

	# pv TZ_GRCAT_GLOBS

	# Execute

	TAIL="\tail";
	TAIL_OPTS="-F --quiet ${_TAIL_N}";

	\which grcat >&/dev/null && {
		GRCAT="\grcat";
		GRCAT_OPTS="conf.lumen-log";
		: return 0
	} || {
		# no grcat available, use cat
		GRCAT="\cat";
		GRCAT_OPTS="";
	}

	FZF="\fzf";
	# FZF_OPTS="--tac --no-sort --height=100% --exact --ansi --no-expect --tabstop=4 --layout=default --bind 'change:last' --bind 'esc:clear-query+last' --bind 'enter:last'";
	FZF_OPTS="--tac --layout=default --height=100% --no-sort --no-expect --exact --ansi --tabstop=4 --bind 'enter:ignore' --bind 'esc:cancel'";

	eval "$TAIL $TAIL_OPTS $* | $GRCAT $GRCAT_OPTS | $FZF $FZF_OPTS;";
	# eval "$CMD";

	# stdbuf can be used to adjust buffering, can't seem to get it to work w/ grcat
	#	stdbuf -i0 -o0

} "$@";

##																									\e[m
##	tz [options] {file}
##		Tails the last -n lines from {file}, following the file and pipes the output through grcat
##		to fzf with some specific options for easily viewing & filtering lines of a file. 
##		tz will attempt to pick a grcat configuration file based on 
##																									\e[m
##		\e[31;1moptions\e[m
##																									\e[m
##			-h		  Shows this help information
##			-v		  Increases verbosity, may be repeated multiple times
##																									\e[m
##		\e[31;1mOptions passed to tail\e[m
##			-n \e[32;1m{num}\e[m 	Defaults to 50,000
##																									\e[m
#X			-c \e[32;1mname\e[m   Use \e[32;1mname\e[m as the container instead of \e[37;1m$DE_CONTAINER\e[m
#X			-C \e[32;1mname\e[m   Set the \e[37;1m$DE_CONTAINER\e[m to \e[32;1mname\e[m
#X				  		  Example: de -C blah sets the DE_CONTAINER environment variable to blah
#X																									\e[m
#X			-n		  Do not perform expansion on \e[32;m{cmd}\e[m
##

#setopt NO_FUNCTION_ARGZERO LOCAL_OPTIONS;

#
#	TODO:
#		implement TZ_GRCAT_GLOBS from zsh-ex/config
#
